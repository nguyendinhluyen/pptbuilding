<?php$title = 'Thêm thương hiệu';$checked = 'checked';$update = 0;$up_new_file = 0;$show_logo = "<img src='" . _STYLE_IMG . "cat.png' width='150px'/>";$xtemplate->path = 'com_ads/';$content = $xtemplate->load('AdsOpt');$flash = $xtemplate->get_block_from_str($content, 'FLASH');$content = $xtemplate->assign_blocks_content($content, array('FLASH' => ''));if (isset($_GET['id'])) {    $id = intval($_GET['id']);    $update = 1;    $title = 'Cập nhật thương hiệu';    $sql = "SELECT description_ads,"            . "adver_webname,"            . "adver_logo,"            . "adver_status,"            . "adver_order,"            . "short_description "            . "FROM ads "            . "WHERE adver_id = '$id'";    $mysql->setQuery($sql);    $row = $mysql->loadOneRow();    $description_ads = output($row['description_ads']);    $checked = ($row['adver_status'] == 1) ? 'checked' : '';    $txtwebname = output($row['adver_webname']);    $adver_logo = output($row['adver_logo']);    $txtorder = intval($row['adver_order']);    $short_description = output($row['short_description']);    if (checkExtentFile($adver_logo, 'swf')) {        $show_logo = $xtemplate->replace($flash, array(            'logo' => _UPLOAD_AD_THUMB . $adver_logo,        ));    } else {        $show_logo = "<img src='" . _UPLOAD_AD . $adver_logo . "' width='150px'/>";    }    $view_adver = _UPLOAD_AD_THUMB . $adver_logo;}if (isset($_POST['btnSub'])) {    $fileAdver = $_FILES["fileAdver"]["name"];    $checked = ($_POST['cbstatus'] == 'on') ? 'checked' : '';    $txtwebname = output($_POST['txtwebname']);    $txtorder = intval($_POST['txtorder']);    $description_ads = $_POST['description_ads'];    $short_description = $_POST['short_description'];    // INSERT    if (($update != 1) || (!empty($fileAdver))) {        if (empty($fileAdver)) {            $error.= '<li>Bạn chưa chọn file </li>';        } else if (!checkExtentFile($_FILES["fileAdver"]["name"], $imgExtent . '|' . $mediaExtent)) {            $error.= '<li>' . $arr_lang['err_checkExtent'] . ' ' . str_replace('|'                            , ',', $imgExtent . '|' . $mediaExtent) . '</li>';        } else {            if (checkExtentFile($_FILES["fileAdver"]["name"], $mediaExtent)) {                if ($_FILES["fileAdver"]["size"] > $mediaSize) {                    $error.='<li>Media quá dung lượng cho phép > ' . formatsize($mediaSize) . '</li>';                }            } else {                if ($_FILES["fileAdver"]["size"] > $imgSize) {                    $error.='<li>Hình ảnh quá dung lượng cho phép > ' . formatsize($imgSize) . '</li>';                }            }        }        if (!empty($fileAdver)) {            $up_new_file = 1;        }    }    if (empty($error)) {        $status = ($_POST['cbstatus'] == 'on') ? '1' : '0';        if ($update != 1) {            $sql = "INSERT INTO ads(description_ads,                                        adver_webname,                                        adver_status,                                        adver_order,                                        short_description,                                        date_added)                                values ('" . $description_ads . "','"                    . input($txtwebname) . "',"                    . $status . ","                    . $txtorder . ",'"                    . $short_description . "',"                    . time() . ")";        } else {            $sql = "UPDATE ads " .                    "SET description_ads='" . $description_ads                    . "',adver_webname = '" . input($txtwebname)                    . "',adver_status =" . $status                    . ",adver_order =" . $txtorder                    . ",short_description ='" . $short_description                    . "',date_modifile =" . time()                    . " WHERE adver_id = $id";        }        $mysql->setQuery($sql);        if ($mysql->query()) {            if (($update == 0) || ($up_new_file == 1)) {                if ($update == 0) {                    $lastId = mysql_insert_id();                } else {                    $lastId = $id;                    if (file_exists(_UPLOAD_AD_THUMB . $adver_logo)) {                        @unlink(_UPLOAD_AD_THUMB . $adver_logo);                    }                    if (file_exists(_UPLOAD_AD . $adver_logo)) {                        @unlink(_UPLOAD_AD . $adver_logo);                    }                }                // Change name                $fileAdver = renameFile($_FILES["fileAdver"]["name"], 'ads-' . input(vitoen($txtwebname, '-') . '-' . $lastId));                // Move to the folder                move_uploaded_file($_FILES ["fileAdver"]["tmp_name"], _UPLOAD_AD_THUMB . $fileAdver);                if (!checkExtentFile($fileAdver, $mediaExtent)) {                    //resize image                    imagejpeg(resize(_UPLOAD_AD_THUMB . $fileAdver, $ImgW), _UPLOAD_AD . $fileAdver);                }                $sql = "UPDATE ads SET adver_logo = '" . $fileAdver . "' WHERE adver_id ='" . $lastId . "'";                $mysql->setQuery($sql);                $result = $mysql->query();            }        }        header("location:./?show=Ads&p=" . intval($_GET['p']));    } else {        $error = '<ul>' . $error . '</ul>';    }}// Use for loading text editor$script = $xtemplate->get_block_from_str($content, "SCRIPT");if (strpos($_SERVER["HTTP_USER_AGENT"], "MSIE")) {    $script .= "<script language=JavaScript src='../inv/scripts/editor.js'></script>";} else {    $script .= "<script language=JavaScript src='../inv/scripts/moz/editor.js'></script>";}$content = $xtemplate->assign_blocks_content($content, array("SCRIPT" => ''));$content = $xtemplate->replace($content, array(    'title' => $title,    'show_logo' => $show_logo,    'txtwebname' => $txtwebname,    'view_adver' => $view_adver,    'description_ads' => $description_ads,    'txtorder' => $txtorder,    'checked' => $checked,    'short_description' => $short_description,    'error' => $error        ));?>